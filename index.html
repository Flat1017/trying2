<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>クリックで色が変わる文字</title>
    <style>
      :root {
        color-scheme: light dark;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: grid;
        place-items: center;
        font-family: "Noto Sans JP", system-ui, -apple-system, sans-serif;
        background: linear-gradient(135deg, #f9fafc 0%, #e8ecf7 100%);
      }

      .page {
        width: min(560px, 90vw);
        display: grid;
        gap: 1.5rem;
      }

      .container {
        text-align: center;
        padding: 2rem 3rem;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 24px;
        box-shadow: 0 24px 45px rgba(23, 33, 77, 0.15);
      }

      .auth-card {
        padding: 2rem;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 24px;
        box-shadow: 0 20px 40px rgba(23, 33, 77, 0.15);
        display: grid;
        gap: 1rem;
      }

      .auth-card h1 {
        margin: 0;
        font-size: 1.5rem;
        color: #1f2a5a;
      }

      .auth-card p {
        margin: 0;
        color: #4c5a89;
        font-size: 0.95rem;
      }

      .auth-form {
        display: grid;
        gap: 0.75rem;
      }

      .auth-form label {
        display: grid;
        gap: 0.35rem;
        font-size: 0.9rem;
        color: #1f2a5a;
        text-align: left;
      }

      .auth-form input {
        border: 1px solid #c9d4f3;
        border-radius: 12px;
        padding: 0.6rem 0.75rem;
        font-size: 1rem;
        font-family: inherit;
      }

      .auth-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
      }

      .auth-actions button {
        border: none;
        border-radius: 999px;
        padding: 0.65rem 1.4rem;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        background: #1f2a5a;
        color: #fff;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .auth-actions button.secondary {
        background: #e8ecf7;
        color: #1f2a5a;
      }

      .auth-actions button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(31, 42, 90, 0.18);
      }

      .auth-message {
        min-height: 1.2rem;
        font-size: 0.9rem;
        color: #e63946;
      }

      .auth-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #2a9d8f;
      }

      .auth-hidden {
        display: none;
      }

      #greeting {
        font-size: clamp(2.5rem, 5vw, 4rem);
        font-weight: 700;
        color: #1f2a5a;
        cursor: pointer;
        transition: color 0.25s ease, transform 0.25s ease;
      }

      #greeting:hover {
        transform: scale(1.03);
      }

      .hint {
        margin-top: 0.75rem;
        font-size: 1rem;
        color: #4c5a89;
      }
    </style>
  </head>
  <body>
    <main class="page">
      <section class="auth-card" id="authCard" aria-live="polite">
        <h1 id="authTitle">認証の設定</h1>
        <p id="authDescription">初回は合言葉を設定してください。次回からは同じ合言葉でログインします。</p>
        <form class="auth-form" id="authForm">
          <label for="passphraseInput">
            合言葉
            <input type="password" id="passphraseInput" autocomplete="current-password" required />
          </label>
          <label for="confirmInput" id="confirmLabel">
            合言葉（確認）
            <input type="password" id="confirmInput" autocomplete="new-password" required />
          </label>
          <div class="auth-actions">
            <button type="submit" id="authSubmit">設定してログイン</button>
            <button type="button" class="secondary" id="resetAuth">認証をリセット</button>
          </div>
          <div class="auth-message" id="authMessage" role="status" aria-live="polite"></div>
        </form>
      </section>

      <section class="container auth-hidden" id="appContent" aria-live="polite">
        <div id="greeting" role="button" tabindex="0" aria-label="クリックで色が変わるこんにちは">
          こんにちは
        </div>
        <div class="hint">クリックすると文字の色が変わります。</div>
        <div class="auth-actions" style="justify-content: center; margin-top: 1.5rem;">
          <span class="auth-status" id="authStatus">ログイン中</span>
          <button type="button" class="secondary" id="logoutButton">ログアウト</button>
        </div>
      </section>
    </main>

    <script>
      const greeting = document.getElementById("greeting");
      const colors = ["#1f2a5a", "#e63946", "#2a9d8f", "#f4a261", "#6f2dbd"];
      let currentIndex = 0;

      const updateColor = () => {
        currentIndex = (currentIndex + 1) % colors.length;
        greeting.style.color = colors[currentIndex];
      };

      greeting.addEventListener("click", updateColor);
      greeting.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          updateColor();
        }
      });

      const authCard = document.getElementById("authCard");
      const appContent = document.getElementById("appContent");
      const authTitle = document.getElementById("authTitle");
      const authDescription = document.getElementById("authDescription");
      const authForm = document.getElementById("authForm");
      const authSubmit = document.getElementById("authSubmit");
      const passphraseInput = document.getElementById("passphraseInput");
      const confirmInput = document.getElementById("confirmInput");
      const confirmLabel = document.getElementById("confirmLabel");
      const authMessage = document.getElementById("authMessage");
      const resetAuth = document.getElementById("resetAuth");
      const logoutButton = document.getElementById("logoutButton");

      const AUTH_HASH_KEY = "site_auth_hash";
      const AUTH_SALT_KEY = "site_auth_salt";
      const AUTH_SESSION_KEY = "site_auth_authenticated";

      const encoder = new TextEncoder();

      const bufferToBase64 = (buffer) =>
        btoa(String.fromCharCode(...new Uint8Array(buffer)));
      const base64ToBuffer = (base64) =>
        Uint8Array.from(atob(base64), (c) => c.charCodeAt(0));

      const deriveKey = async (passphrase, salt) => {
        const keyMaterial = await window.crypto.subtle.importKey(
          "raw",
          encoder.encode(passphrase),
          "PBKDF2",
          false,
          ["deriveBits"]
        );

        return window.crypto.subtle.deriveBits(
          {
            name: "PBKDF2",
            salt,
            iterations: 120000,
            hash: "SHA-256",
          },
          keyMaterial,
          256
        );
      };

      const setAuthMessage = (message, isError = true) => {
        authMessage.textContent = message;
        authMessage.style.color = isError ? "#e63946" : "#2a9d8f";
      };

      const showApp = () => {
        appContent.classList.remove("auth-hidden");
        authCard.classList.add("auth-hidden");
        sessionStorage.setItem(AUTH_SESSION_KEY, "true");
      };

      const showAuth = () => {
        appContent.classList.add("auth-hidden");
        authCard.classList.remove("auth-hidden");
        sessionStorage.removeItem(AUTH_SESSION_KEY);
      };

      const updateAuthUI = () => {
        const hasCredential = Boolean(
          localStorage.getItem(AUTH_HASH_KEY) && localStorage.getItem(AUTH_SALT_KEY)
        );
        const isAuthenticated = sessionStorage.getItem(AUTH_SESSION_KEY) === "true";

        if (isAuthenticated) {
          showApp();
          return;
        }

        showAuth();
        if (hasCredential) {
          authTitle.textContent = "ログイン";
          authDescription.textContent = "設定済みの合言葉を入力してください。";
          confirmLabel.classList.add("auth-hidden");
          confirmInput.required = false;
          confirmInput.value = "";
          authSubmit.textContent = "ログイン";
        } else {
          authTitle.textContent = "認証の設定";
          authDescription.textContent =
            "初回は合言葉を設定してください。次回からは同じ合言葉でログインします。";
          confirmLabel.classList.remove("auth-hidden");
          confirmInput.required = true;
          authSubmit.textContent = "設定してログイン";
        }
      };

      const handleSetup = async (passphrase) => {
        const salt = window.crypto.getRandomValues(new Uint8Array(16));
        const hashBuffer = await deriveKey(passphrase, salt);
        localStorage.setItem(AUTH_SALT_KEY, bufferToBase64(salt));
        localStorage.setItem(AUTH_HASH_KEY, bufferToBase64(hashBuffer));
      };

      const verifyPassphrase = async (passphrase) => {
        const storedSalt = localStorage.getItem(AUTH_SALT_KEY);
        const storedHash = localStorage.getItem(AUTH_HASH_KEY);
        if (!storedSalt || !storedHash) {
          return false;
        }
        const salt = base64ToBuffer(storedSalt);
        const hashBuffer = await deriveKey(passphrase, salt);
        return bufferToBase64(hashBuffer) === storedHash;
      };

      authForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        setAuthMessage("");
        const passphrase = passphraseInput.value.trim();
        if (!passphrase) {
          setAuthMessage("合言葉を入力してください。");
          return;
        }

        const hasCredential = Boolean(
          localStorage.getItem(AUTH_HASH_KEY) && localStorage.getItem(AUTH_SALT_KEY)
        );

        try {
          if (!hasCredential) {
            if (passphrase !== confirmInput.value.trim()) {
              setAuthMessage("確認用の合言葉が一致しません。");
              return;
            }
            await handleSetup(passphrase);
            setAuthMessage("設定が完了しました。ログインします。", false);
            showApp();
          } else {
            const ok = await verifyPassphrase(passphrase);
            if (!ok) {
              setAuthMessage("合言葉が違います。もう一度お試しください。");
              return;
            }
            setAuthMessage("ログインしました。", false);
            showApp();
          }
          passphraseInput.value = "";
          confirmInput.value = "";
        } catch (error) {
          setAuthMessage("認証情報の処理に失敗しました。");
          console.error(error);
        }
      });

      resetAuth.addEventListener("click", () => {
        localStorage.removeItem(AUTH_HASH_KEY);
        localStorage.removeItem(AUTH_SALT_KEY);
        setAuthMessage("認証情報をリセットしました。再設定してください。", false);
        updateAuthUI();
      });

      logoutButton.addEventListener("click", () => {
        showAuth();
        updateAuthUI();
      });

      updateAuthUI();
    </script>
  </body>
</html>
